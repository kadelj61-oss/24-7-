<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Remote Camera Stream Viewer</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { font-family: Arial, sans-serif; margin: 24px; background: #f9f9f9; color: #222; }
        .container { max-width: 700px; margin: auto; background: #fff; padding:2em; border-radius: 12px; box-shadow: 0 4px 20px #0001; }
        label { display: block; margin-bottom: 8px; }
        input[type="text"], button { padding: 8px 12px; font-size: 1em; }
        #streamBox { margin-top: 2em; text-align: center; }
        #remoteStream { max-width: 100%; border: 2px solid #333; border-radius: 8px; min-height: 320px; background: #111; }
        #status, #stats { margin-top: 1em; padding:8px; border-radius:4px; }
        #status.error { background: #fdd; color: #a22; }
        #status.success { background: #dfd; color: #283; }
        #stats { background: #eef; }
    </style>
</head>
<body>
<div class="container">
    <h1>Remote Camera Stream Viewer</h1>
    <label for="backendUrl">
        Flask backend URL (no slash at end):<br>
        <small>(e.g. <code>https://direction-may-banners-december.trycloudflare.com</code>)</small>
    </label>
    <input type="text" id="backendUrl" value="https://direction-may-banners-december.trycloudflare.com" style="width:85%">
    <button id="connectBtn">Connect</button>
    
    <div id="status"></div>
    <div id="stats"></div>
    
    <div id="streamBox">
        <img id="remoteStream" alt="Remote camera stream appears here">
        <div style="color:#888; margin-top:6px"><small>If the stream does not appear, check backend URL and open the tunnel!</small></div>
    </div>
</div>

<script>
const $ = id => document.getElementById(id);
let lastBackendUrl = "";

function setStatus(msg, isError) {
    $('status').textContent = msg;
    $('status').className = isError ? 'error' : 'success';
}
function setStats(obj) {
    if (!obj) { $('stats').textContent = ''; return; }
    $('stats').textContent = Object.entries(obj).map(([k,v])=>`${k}: ${v}`).join(' â€¢ ');
}
$('connectBtn').onclick = async function() {
    const url = $('backendUrl').value.replace(/\/$/, '');
    lastBackendUrl = url;
    setStatus('Connecting...', false);
    setStats(null);

    // HEALTH CHECK
    try {
        const healthRes = await fetch(url+'/health');
        if (!healthRes.ok) {
            setStatus(`Health check failed: HTTP ${healthRes.status}`, true);
            $('remoteStream').src = '';
            return;
        }
        const health = await healthRes.json();
        if (!(health.status && (health.status === "OK" || health.status === "ok"))) {
            setStatus('Health check error: invalid status', true);
            $('remoteStream').src = '';
            return;
        }
        setStatus('Backend OK', false);
    } catch (e) {
        setStatus('Could not reach backend /health: ' + e.message, true);
        $('remoteStream').src = '';
        return;
    }

    // Get stats if available
    try {
        const statsRes = await fetch(url+'/api/stats');
        if (statsRes.ok) {
            const stats = await statsRes.json();
            setStats(stats);
        } else {
            setStats(null);
        }
    } catch { setStats(null); }

    // Start Stream
    $('remoteStream').src = url+'/stream';
    $('remoteStream').alt = 'Connecting to stream...';
};

window.onload = () => {
    $('connectBtn').click();
};
</script>
</body>
</html>
